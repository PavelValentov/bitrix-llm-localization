# Руководство по архитектуре

## Принципы работы

Система построена на принципе "Симметричной локализации". Это означает, что структура файлов и ключей должна быть идентична для всех поддерживаемых языков.

### Процесс (Pipeline)

1.  **Extract (Агрегация)**:
    *   Скрипт проходит по всем файлам `.php` в папках `/lang/ru/`, `/lang/en/` и т.д.
    *   Пути нормализуются: `/modules/crm/lang/ru/options.php` превращается в виртуальный путь `/modules/crm/lang/{lang}/options.php`.
    *   Все найденные ключи `$MESS` собираются в единый объект.
    *   Если файл существует в одном языке, но отсутствует в другом, в JSON создается запись с `null` для отсутствующего языка.

2.  **Transform (Перевод/Редактирование)**:
    *   На этом этапе JSON файл может быть обработан внешними инструментами (например, скриптом перевода через OpenAI).
    *   Задача этапа — заполнить `null` значения реальными переводами.

3.  **Load (Восстановление)**:
    *   Скрипт читает JSON.
    *   Определяет список активных языков (все языки, которые встречаются в файле).
    *   Генерирует физические файлы `.php` для **каждого** активного языка.
    *   Даже если для файла нет переводов (пустой объект), создается файл-заглушка `<? ?>`. Это гарантирует, что Bitrix не выдаст ошибку "файл не найден" при переключении языка.

## Формат данных (localization.json)

```json
{
  "путь/к/файлу/относительно/корня": {
    "KEY_NAME": {
      "ru": "Значение на русском",
      "en": "Value in English",
      "de": null 
    }
  }
}
```

*   **Путь**: Относительный путь, где `{lang}` заменяет код языка.
*   **null**: Означает, что перевод отсутствует (скрипт восстановления пропустит этот ключ при генерации файла, но сам файл создаст).
*   **"" (пустая строка)**: Означает, что перевод есть, но он пустой (скрипт восстановления создаст запись `$MESS['...'] = '';`).

## Поддерживаемые языки

Список языков жестко задан в `src/utils.ts` (`ALLOWED_LANGUAGES`) для предотвращения обработки случайных папок как языковых (например, `install`, `admin`).

Основные поддерживаемые коды: `ru`, `en`, `de`, `ua`, `kz`, `by`, `fr`, `it`, `es`, `pl`, `tr`, `br`, `la`, `sc`, `tc`, `vn`, `ja`, `th`, `id`, `hi`.
